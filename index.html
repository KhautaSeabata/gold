<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MT5 Deriv Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow-x: hidden;
            height: 100vh;
        }
        
        /* MT5 Header */
        .mt5-header {
            background: #1C1C1E;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #2C2C2E;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .mt5-logo {
            font-size: 20px;
            font-weight: 700;
            color: #007AFF;
        }
        .account-info {
            display: flex;
            flex-direction: column;
        }
        .account-number {
            font-size: 11px;
            color: #8E8E93;
        }
        .account-balance {
            font-size: 14px;
            color: #30D158;
            font-weight: 600;
        }
        
        /* Bottom Navigation */
        .mt5-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1C1C1E;
            display: flex;
            justify-content: space-around;
            padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
            border-top: 1px solid #2C2C2E;
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            flex: 1;
            padding: 4px;
            color: #8E8E93;
            transition: color 0.2s;
        }
        .nav-item.active {
            color: #007AFF;
        }
        .nav-icon {
            font-size: 26px;
        }
        .nav-label {
            font-size: 10px;
        }
        
        /* Pages */
        .page-container {
            display: none;
            height: calc(100vh - 140px);
            overflow-y: auto;
        }
        .page-container.active {
            display: block;
        }
        
        /* Charts Page */
        .chart-toolbar {
            background: #1C1C1E;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            overflow-x: auto;
            border-bottom: 1px solid #2C2C2E;
        }
        .chart-toolbar::-webkit-scrollbar {
            display: none;
        }
        .toolbar-select {
            background: #2C2C2E;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            outline: none;
        }
        .toolbar-btn {
            background: #2C2C2E;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            cursor: pointer;
        }
        .toolbar-btn.active {
            background: #007AFF;
        }
        
        .chart-view {
            position: relative;
            height: calc(100vh - 260px);
            background: #000;
        }
        .single-chart {
            display: none;
            height: 100%;
            flex-direction: column;
        }
        .single-chart.active {
            display: flex;
        }
        
        .chart-info-bar {
            background: #1C1C1E;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            border-bottom: 1px solid #2C2C2E;
        }
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .info-label {
            color: #8E8E93;
        }
        .info-value {
            font-weight: 600;
            font-size: 13px;
        }
        
        .chart-canvas-container {
            flex: 1;
            position: relative;
            background: #000;
            overflow: hidden;
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .zoom-controls {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            border: none;
            background: rgba(28, 28, 30, 0.8);
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        
        .chart-tabs {
            background: #1C1C1E;
            display: flex;
            overflow-x: auto;
            border-top: 1px solid #2C2C2E;
            padding: 0 15px;
        }
        .chart-tabs::-webkit-scrollbar {
            display: none;
        }
        .chart-tab {
            padding: 12px 20px;
            cursor: pointer;
            color: #8E8E93;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            font-size: 14px;
        }
        .chart-tab.active {
            color: #007AFF;
            border-bottom-color: #007AFF;
        }
        
        /* Signals Page */
        .signals-header {
            background: #1C1C1E;
            padding: 15px;
            border-bottom: 1px solid #2C2C2E;
        }
        .signals-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .signals-controls {
            display: flex;
            gap: 10px;
        }
        .signal-filter-btn {
            padding: 6px 12px;
            background: #2C2C2E;
            border: none;
            color: white;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        .signal-filter-btn.active {
            background: #007AFF;
        }
        
        .signals-list {
            padding: 15px;
        }
        .signal-card {
            background: #1C1C1E;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #007AFF;
        }
        .signal-card.bullish {
            border-left-color: #30D158;
        }
        .signal-card.bearish {
            border-left-color: #FF453A;
        }
        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .signal-name {
            font-size: 16px;
            font-weight: 600;
        }
        .signal-badge {
            background: rgba(0, 122, 255, 0.2);
            color: #007AFF;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        .signal-badge.bullish {
            background: rgba(48, 209, 88, 0.2);
            color: #30D158;
        }
        .signal-badge.bearish {
            background: rgba(255, 69, 58, 0.2);
            color: #FF453A;
        }
        .signal-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        .signal-detail {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        .detail-label {
            color: #8E8E93;
        }
        .detail-value {
            font-weight: 600;
        }
        .confidence-bar {
            height: 4px;
            background: #2C2C2E;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }
        .confidence-fill {
            height: 100%;
            background: #007AFF;
            transition: width 0.3s;
        }
        .confidence-fill.high {
            background: #30D158;
        }
        .signal-time {
            font-size: 11px;
            color: #8E8E93;
            margin-top: 8px;
        }
        
        .no-signals {
            text-align: center;
            padding: 60px 20px;
            color: #8E8E93;
        }
        .no-signals-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }
        
        /* Settings Page */
        .settings-section {
            background: #1C1C1E;
            margin: 15px;
            border-radius: 12px;
            overflow: hidden;
        }
        .settings-item {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2C2C2E;
        }
        .settings-item:last-child {
            border-bottom: none;
        }
        .settings-label {
            font-size: 15px;
        }
        .settings-value {
            color: #8E8E93;
            font-size: 14px;
        }
        .toggle-switch {
            width: 50px;
            height: 30px;
            background: #2C2C2E;
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: #30D158;
        }
        .toggle-thumb {
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 13px;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }
        .toggle-switch.active .toggle-thumb {
            left: 22px;
        }
        
        .green { color: #30D158; }
        .red { color: #FF453A; }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 4px;
            margin-right: 6px;
        }
        .status-connected {
            background: #30D158;
        }
        .status-disconnected {
            background: #FF453A;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="mt5-header">
        <div class="header-left">
            <div class="mt5-logo">MT5</div>
            <div class="account-info">
                <div class="account-number">Demo #1234567</div>
                <div class="account-balance">$10,000.00</div>
            </div>
        </div>
        <div id="connectionStatus">
            <span class="status-indicator status-disconnected"></span>
        </div>
    </div>

    <!-- Charts Page -->
    <div class="page-container active" id="chartsPage">
        <!-- Toolbar -->
        <div class="chart-toolbar">
            <select class="toolbar-select" id="numCharts" onchange="changeNumCharts()">
                <option value="1">1 Chart</option>
                <option value="2">2 Charts</option>
                <option value="3">3 Charts</option>
                <option value="4" selected>4 Charts</option>
            </select>
            <button class="toolbar-btn" onclick="startAllCharts()">‚ñ∂ Start</button>
            <button class="toolbar-btn" onclick="stopAllCharts()">‚è∏ Stop</button>
            <button class="toolbar-btn" onclick="refreshAllCharts()">üîÑ</button>
            <button class="toolbar-btn" id="analysisToggle" onclick="toggleAnalysis()">üìä ON</button>
        </div>

        <!-- Chart View -->
        <div class="chart-view">
            <!-- Chart 1 -->
            <div class="single-chart active" id="chart1">
                <div class="chart-info-bar">
                    <div class="info-item">
                        <div class="info-label">Symbol</div>
                        <div class="info-value" id="symbolName1">Vol 25</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Price</div>
                        <div class="info-value" id="price1">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Change</div>
                        <div class="info-value" id="change1">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">H/L</div>
                        <div class="info-value" id="highlow1">--</div>
                    </div>
                </div>
                <div class="chart-toolbar">
                    <select class="toolbar-select" id="symbol1" onchange="updateChart(1)">
                        <option value="R_10">Vol 10</option>
                        <option value="R_25" selected>Vol 25</option>
                        <option value="R_50">Vol 50</option>
                        <option value="R_75">Vol 75</option>
                        <option value="R_100">Vol 100</option>
                    </select>
                    <select class="toolbar-select" id="timeframe1" onchange="updateChart(1)">
                        <option value="60" selected>1M</option>
                        <option value="300">5M</option>
                        <option value="900">15M</option>
                        <option value="1800">30M</option>
                        <option value="3600">1H</option>
                    </select>
                </div>
                <div class="chart-canvas-container">
                    <canvas id="canvas1"></canvas>
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoom(1, 'in')">+</button>
                        <button class="zoom-btn" onclick="zoom(1, 'out')">‚àí</button>
                    </div>
                </div>
            </div>

            <!-- Chart 2 -->
            <div class="single-chart" id="chart2">
                <div class="chart-info-bar">
                    <div class="info-item">
                        <div class="info-label">Symbol</div>
                        <div class="info-value" id="symbolName2">Vol 50</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Price</div>
                        <div class="info-value" id="price2">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Change</div>
                        <div class="info-value" id="change2">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">H/L</div>
                        <div class="info-value" id="highlow2">--</div>
                    </div>
                </div>
                <div class="chart-toolbar">
                    <select class="toolbar-select" id="symbol2" onchange="updateChart(2)">
                        <option value="R_10">Vol 10</option>
                        <option value="R_25">Vol 25</option>
                        <option value="R_50" selected>Vol 50</option>
                        <option value="R_75">Vol 75</option>
                        <option value="R_100">Vol 100</option>
                    </select>
                    <select class="toolbar-select" id="timeframe2" onchange="updateChart(2)">
                        <option value="60">1M</option>
                        <option value="300" selected>5M</option>
                        <option value="900">15M</option>
                        <option value="1800">30M</option>
                        <option value="3600">1H</option>
                    </select>
                </div>
                <div class="chart-canvas-container">
                    <canvas id="canvas2"></canvas>
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoom(2, 'in')">+</button>
                        <button class="zoom-btn" onclick="zoom(2, 'out')">‚àí</button>
                    </div>
                </div>
            </div>

            <!-- Chart 3 -->
            <div class="single-chart" id="chart3">
                <div class="chart-info-bar">
                    <div class="info-item">
                        <div class="info-label">Symbol</div>
                        <div class="info-value" id="symbolName3">Vol 75</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Price</div>
                        <div class="info-value" id="price3">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Change</div>
                        <div class="info-value" id="change3">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">H/L</div>
                        <div class="info-value" id="highlow3">--</div>
                    </div>
                </div>
                <div class="chart-toolbar">
                    <select class="toolbar-select" id="symbol3" onchange="updateChart(3)">
                        <option value="R_10">Vol 10</option>
                        <option value="R_25">Vol 25</option>
                        <option value="R_50">Vol 50</option>
                        <option value="R_75" selected>Vol 75</option>
                        <option value="R_100">Vol 100</option>
                    </select>
                    <select class="toolbar-select" id="timeframe3" onchange="updateChart(3)">
                        <option value="60">1M</option>
                        <option value="300">5M</option>
                        <option value="900" selected>15M</option>
                        <option value="1800">30M</option>
                        <option value="3600">1H</option>
                    </select>
                </div>
                <div class="chart-canvas-container">
                    <canvas id="canvas3"></canvas>
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoom(3, 'in')">+</button>
                        <button class="zoom-btn" onclick="zoom(3, 'out')">‚àí</button>
                    </div>
                </div>
            </div>

            <!-- Chart 4 -->
            <div class="single-chart" id="chart4">
                <div class="chart-info-bar">
                    <div class="info-item">
                        <div class="info-label">Symbol</div>
                        <div class="info-value" id="symbolName4">Vol 100</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Price</div>
                        <div class="info-value" id="price4">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Change</div>
                        <div class="info-value" id="change4">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">H/L</div>
                        <div class="info-value" id="highlow4">--</div>
                    </div>
                </div>
                <div class="chart-toolbar">
                    <select class="toolbar-select" id="symbol4" onchange="updateChart(4)">
                        <option value="R_10">Vol 10</option>
                        <option value="R_25">Vol 25</option>
                        <option value="R_50">Vol 50</option>
                        <option value="R_75">Vol 75</option>
                        <option value="R_100" selected>Vol 100</option>
                    </select>
                    <select class="toolbar-select" id="timeframe4" onchange="updateChart(4)">
                        <option value="60">1M</option>
                        <option value="300">5M</option>
                        <option value="900">15M</option>
                        <option value="1800" selected>30M</option>
                        <option value="3600">1H</option>
                    </select>
                </div>
                <div class="chart-canvas-container">
                    <canvas id="canvas4"></canvas>
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoom(4, 'in')">+</button>
                        <button class="zoom-btn" onclick="zoom(4, 'out')">‚àí</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Tabs -->
        <div class="chart-tabs" id="chartTabs">
            <div class="chart-tab active" onclick="switchChart(1)">Chart 1</div>
            <div class="chart-tab" onclick="switchChart(2)">Chart 2</div>
            <div class="chart-tab" onclick="switchChart(3)">Chart 3</div>
            <div class="chart-tab" onclick="switchChart(4)">Chart 4</div>
        </div>
    </div>

    <!-- Signals Page -->
    <div class="page-container" id="signalsPage">
        <div class="signals-header">
            <div class="signals-title">Trading Signals</div>
            <div class="signals-controls">
                <button class="signal-filter-btn active" onclick="filterSignals('all')">All</button>
                <button class="signal-filter-btn" onclick="filterSignals('bullish')">Bullish</button>
                <button class="signal-filter-btn" onclick="filterSignals('bearish')">Bearish</button>
            </div>
        </div>
        <div class="signals-list" id="signalsList">
            <div class="no-signals">
                <div class="no-signals-icon">üìä</div>
                <div>No signals detected yet</div>
                <div style="font-size: 12px; margin-top: 8px;">Start charts to detect patterns</div>
            </div>
        </div>
    </div>

    <!-- Settings Page -->
    <div class="page-container" id="settingsPage">
        <div class="settings-section">
            <div class="settings-item">
                <div class="settings-label">Pattern Analysis</div>
                <div class="toggle-switch active" onclick="toggleSetting(this)">
                    <div class="toggle-thumb"></div>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-label">Sound Alerts</div>
                <div class="toggle-switch active" onclick="toggleSetting(this)">
                    <div class="toggle-thumb"></div>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-label">Push Notifications</div>
                <div class="toggle-switch" onclick="toggleSetting(this)">
                    <div class="toggle-thumb"></div>
                </div>
            </div>
        </div>
        <div class="settings-section" style="margin-top: 20px;">
            <div class="settings-item">
                <div class="settings-label">Clear All Signals</div>
                <button class="toolbar-btn" onclick="clearAllSignals()" style="background: #FF453A;">Clear</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="mt5-bottom-nav">
        <div class="nav-item active" onclick="switchPage('chartsPage')">
            <div class="nav-icon">üìà</div>
            <div class="nav-label">Charts</div>
        </div>
        <div class="nav-item" onclick="switchPage('signalsPage')">
            <div class="nav-icon">üéØ</div>
            <div class="nav-label">Signals</div>
        </div>
        <div class="nav-item" onclick="switchPage('settingsPage')">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div class="nav-label">Settings</div>
        </div>
    </div>

    <script>
        const FIREBASE_URL = 'https://alerts-83c9b-default-rtdb.firebaseio.com';
        
        let charts = {};
        let currentChartView = 1;
        let numActiveCharts = 4;
        let analysisEnabled = true;
        let allSignals = [];
        let signalFilter = 'all';

        class ChartManager {
            constructor(id) {
                this.id = id;
                this.canvas = document.getElementById(`canvas${id}`);
                this.ctx = this.canvas.getContext('2d');
                this.data = [];
                this.ws = null;
                this.symbol = document.getElementById(`symbol${id}`).value;
                this.timeframe = parseInt(document.getElementById(`timeframe${id}`).value);
                this.zoom = 80;
                this.offset = 0;
                this.dragging = false;
                this.autoScroll = true;
                this.analysis = {};
                
                this.resizeCanvas();
                this.setupDrag();
            }

            resizeCanvas() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
            }

            setupDrag() {
                let startX, startOffset;
                this.canvas.addEventListener('touchstart', (e) => {
                    this.dragging = true;
                    startX = e.touches[0].clientX;
                    startOffset = this.offset;
                    this.autoScroll = false;
                });
                this.canvas.addEventListener('touchmove', (e) => {
                    if (!this.dragging) return;
                    const deltaX = e.touches[0].clientX - startX;
                    const candlesPerScreen = Math.floor(this.zoom);
                    const pixelsPerCandle = this.canvas.width / candlesPerScreen;
                    const candlesDelta = Math.round(deltaX / pixelsPerCandle);
                    this.offset = Math.max(0, Math.min(this.data.length - candlesPerScreen, startOffset - candlesDelta));
                    this.draw();
                });
                this.canvas.addEventListener('touchend', () => {
                    this.dragging = false;
                    if (this.offset >= this.data.length - this.zoom - 5) {
                        this.autoScroll = true;
                    }
                });
            }

            connect() {
                if (this.ws) this.ws.close();
                
                this.ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
                
                this.ws.onopen = () => {
                    updateConnectionStatus(true);
                    this.ws.send(JSON.stringify({ ticks: this.symbol, subscribe: 1 }));
                    this.ws.send(JSON.stringify({
                        ticks_history: this.symbol,
                        count: 1000,
                        end: 'latest',
                        style: 'candles',
                        granularity: this.timeframe
                    }));
                };

                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.candles) {
                        this.data = data.candles.map(c => ({
                            x: c.epoch * 1000,
                            o: parseFloat(c.open),
                            h: parseFloat(c.high),
                            l: parseFloat(c.low),
                            c: parseFloat(c.close)
                        }));
                        this.draw();
                        this.updateInfo();
                        if (analysisEnabled) this.analyze();
                    } else if (data.tick) {
                        this.updateTick(parseFloat(data.tick.quote), data.tick.epoch * 1000);
                    }
                };

                this.ws.onerror = () => updateConnectionStatus(false);
                this.ws.onclose = () => updateConnectionStatus(false);
            }

            updateTick(price, time) {
                                const candleStart = Math.floor(time / (this.timeframe * 1000)) * (this.timeframe * 1000);
                
                if (!this.data.length || candleStart > this.data[this.data.length - 1].x) {
                    this.data.push({ x: candleStart, o: price, h: price, l: price, c: price });
                    if (this.data.length > 1000) this.data.shift();
                    if (analysisEnabled) this.analyze();
                } else {
                    const last = this.data[this.data.length - 1];
                    last.c = price;
                    last.h = Math.max(last.h, price);
                    last.l = Math.min(last.l, price);
                }
                
                this.draw();
                this.updateInfo();
            }

            analyze() {
                if (this.data.length < 30) return;
                
                const patterns = this.detectPatterns();
                patterns.forEach(p => addSignal(p));
            }

            detectPatterns() {
                const patterns = [];
                const recent = this.data.slice(-50);
                
                // Simple pattern detection
                const highs = recent.map(c => c.h);
                const lows = recent.map(c => c.l);
                const closes = recent.map(c => c.c);
                
                // Trend detection
                const slope = this.calculateSlope(closes);
                if (Math.abs(slope) > 0.001) {
                    const pattern = {
                        id: Date.now() + Math.random(),
                        chartId: this.id,
                        name: slope > 0 ? 'Bullish Trend' : 'Bearish Trend',
                        bias: slope > 0 ? 'bullish' : 'bearish',
                        timeframe: this.timeframe,
                        entry: closes[closes.length - 1].toFixed(5),
                        tp1: (closes[closes.length - 1] + slope * 10).toFixed(5),
                        tp2: (closes[closes.length - 1] + slope * 20).toFixed(5),
                        tp3: (closes[closes.length - 1] + slope * 30).toFixed(5),
                        sl: (closes[closes.length - 1] - slope * 15).toFixed(5),
                        confidence: Math.min(95, 60 + Math.abs(slope) * 1000),
                        timestamp: Date.now()
                    };
                    patterns.push(pattern);
                }
                
                return patterns;
            }

            calculateSlope(data) {
                const n = data.length;
                let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
                for (let i = 0; i < n; i++) {
                    sumX += i;
                    sumY += data[i];
                    sumXY += i * data[i];
                    sumX2 += i * i;
                }
                return (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            }

            draw() {
                if (!this.data.length) return;
                
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                const padding = { top: 20, right: 10, bottom: 20, left: 50 };
                const chartW = this.canvas.width - padding.left - padding.right;
                const chartH = this.canvas.height - padding.top - padding.bottom;
                
                const candlesPerScreen = Math.floor(this.zoom);
                if (this.autoScroll) {
                    this.offset = Math.max(0, this.data.length - candlesPerScreen);
                }
                
                const visible = this.data.slice(this.offset, this.offset + candlesPerScreen);
                if (!visible.length) return;
                
                const prices = visible.flatMap(c => [c.h, c.l]);
                const maxP = Math.max(...prices);
                const minP = Math.min(...prices);
                const range = maxP - minP;
                const pad = range * 0.1;
                
                const candleW = Math.max(2, Math.min(12, chartW / visible.length - 2));
                const spacing = chartW / visible.length;
                
                // Grid
                this.ctx.strokeStyle = '#2C2C2E';
                this.ctx.lineWidth = 1;
                for (let i = 0; i <= 4; i++) {
                    const y = padding.top + (chartH / 4) * i;
                    this.ctx.beginPath();
                    this.ctx.moveTo(padding.left, y);
                    this.ctx.lineTo(this.canvas.width - padding.right, y);
                    this.ctx.stroke();
                    
                    const price = maxP + pad - (range + pad * 2) * (i / 4);
                    this.ctx.fillStyle = '#8E8E93';
                    this.ctx.font = '10px Arial';
                    this.ctx.textAlign = 'right';
                    this.ctx.fillText(price.toFixed(2), padding.left - 5, y + 3);
                }
                
                // Candles
                visible.forEach((c, i) => {
                    const x = padding.left + spacing * i + spacing / 2;
                    const yH = padding.top + ((maxP + pad - c.h) / (range + pad * 2)) * chartH;
                    const yL = padding.top + ((maxP + pad - c.l) / (range + pad * 2)) * chartH;
                    const yO = padding.top + ((maxP + pad - c.o) / (range + pad * 2)) * chartH;
                    const yC = padding.top + ((maxP + pad - c.c) / (range + pad * 2)) * chartH;
                    
                    const isUp = c.c >= c.o;
                    const color = isUp ? '#30D158' : '#FF453A';
                    
                    // Wick
                    this.ctx.strokeStyle = color;
                    this.ctx.lineWidth = Math.max(1, candleW / 4);
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, yH);
                    this.ctx.lineTo(x, yL);
                    this.ctx.stroke();
                    
                    // Body
                    this.ctx.fillStyle = color;
                    const bodyH = Math.max(Math.abs(yC - yO), 1);
                    this.ctx.fillRect(x - candleW / 2, Math.min(yO, yC), candleW, bodyH);
                });
            }

            updateInfo() {
                if (!this.data.length) return;
                
                const current = this.data[this.data.length - 1];
                const first = this.data[0];
                const change = current.c - first.o;
                
                const prices = this.data.flatMap(c => [c.h, c.l]);
                const high = Math.max(...prices);
                const low = Math.min(...prices);
                
                document.getElementById(`price${this.id}`).textContent = current.c.toFixed(2);
                
                const changeEl = document.getElementById(`change${this.id}`);
                changeEl.innerHTML = `<span class="${change >= 0 ? 'green' : 'red'}">${change >= 0 ? '+' : ''}${change.toFixed(2)}</span>`;
                
                document.getElementById(`highlow${this.id}`).textContent = `${high.toFixed(2)}/${low.toFixed(2)}`;
            }

            disconnect() {
                if (this.ws) this.ws.close();
            }
        }

        // Initialize charts
        for (let i = 1; i <= 4; i++) {
            charts[i] = new ChartManager(i);
        }

        // Page switching
        function switchPage(pageId) {
            document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach((item, idx) => {
                item.classList.remove('active');
                if ((pageId === 'chartsPage' && idx === 0) ||
                    (pageId === 'signalsPage' && idx === 1) ||
                    (pageId === 'settingsPage' && idx === 2)) {
                    item.classList.add('active');
                }
            });
            
            if (pageId === 'signalsPage') {
                displaySignals();
            }
        }

        // Chart switching
        function switchChart(chartId) {
            document.querySelectorAll('.single-chart').forEach(c => c.classList.remove('active'));
            document.getElementById(`chart${chartId}`).classList.add('active');
            
            document.querySelectorAll('.chart-tab').forEach((tab, idx) => {
                tab.classList.remove('active');
                if (idx === chartId - 1) tab.classList.add('active');
            });
            
            currentChartView = chartId;
            charts[chartId].resizeCanvas();
            charts[chartId].draw();
        }

        function changeNumCharts() {
            numActiveCharts = parseInt(document.getElementById('numCharts').value);
            const tabs = document.getElementById('chartTabs');
            tabs.innerHTML = '';
            for (let i = 1; i <= numActiveCharts; i++) {
                const tab = document.createElement('div');
                tab.className = `chart-tab ${i === 1 ? 'active' : ''}`;
                tab.textContent = `Chart ${i}`;
                tab.onclick = () => switchChart(i);
                tabs.appendChild(tab);
            }
            switchChart(1);
        }

        function updateChart(id) {
            const chart = charts[id];
            chart.symbol = document.getElementById(`symbol${id}`).value;
            chart.timeframe = parseInt(document.getElementById(`timeframe${id}`).value);
            
            const symbolEl = document.getElementById(`symbol${id}`);
            document.getElementById(`symbolName${id}`).textContent = symbolEl.options[symbolEl.selectedIndex].text;
            
            if (chart.ws && chart.ws.readyState === WebSocket.OPEN) {
                chart.disconnect();
                setTimeout(() => chart.connect(), 300);
            }
        }

        function zoom(id, dir) {
            const chart = charts[id];
            if (dir === 'in') {
                chart.zoom = Math.max(20, chart.zoom - 10);
            } else {
                chart.zoom = Math.min(150, chart.zoom + 10);
            }
            chart.draw();
        }

        function startAllCharts() {
            for (let i = 1; i <= numActiveCharts; i++) {
                charts[i].connect();
            }
        }

        function stopAllCharts() {
            for (let i = 1; i <= numActiveCharts; i++) {
                charts[i].disconnect();
            }
        }

        function refreshAllCharts() {
            stopAllCharts();
            setTimeout(() => startAllCharts(), 500);
        }

        function toggleAnalysis() {
            analysisEnabled = !analysisEnabled;
            const btn = document.getElementById('analysisToggle');
            btn.textContent = analysisEnabled ? 'üìä ON' : 'üìä OFF';
            btn.style.background = analysisEnabled ? '#007AFF' : '#2C2C2E';
        }

        function updateConnectionStatus(connected) {
            const indicator = document.querySelector('.status-indicator');
            indicator.className = `status-indicator ${connected ? 'status-connected' : 'status-disconnected'}`;
        }

        // Signal management
        function addSignal(signal) {
            const exists = allSignals.find(s => 
                s.name === signal.name && 
                s.chartId === signal.chartId && 
                Date.now() - s.timestamp < 300000
            );
            
            if (!exists) {
                allSignals.unshift(signal);
                allSignals = allSignals.slice(0, 50);
                saveSignalToFirebase(signal);
                
                if (signal.confidence >= 85) {
                    playSound();
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('High Confidence Signal!', {
                            body: `${signal.name} - ${signal.bias.toUpperCase()}`
                        });
                    }
                }
            }
        }

        async function saveSignalToFirebase(signal) {
            try {
                await fetch(`${FIREBASE_URL}/signals/${signal.id}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(signal)
                });
            } catch (e) {
                console.error('Firebase error:', e);
            }
        }

        async function loadSignalsFromFirebase() {
            try {
                const response = await fetch(`${FIREBASE_URL}/signals.json`);
                const data = await response.json();
                if (data) {
                    allSignals = Object.values(data).sort((a, b) => b.timestamp - a.timestamp);
                    displaySignals();
                }
            } catch (e) {
                console.error('Firebase load error:', e);
            }
        }

        function displaySignals() {
            const container = document.getElementById('signalsList');
            
            let filtered = allSignals;
            if (signalFilter !== 'all') {
                filtered = allSignals.filter(s => s.bias === signalFilter);
            }
            
            if (!filtered.length) {
                container.innerHTML = `
                    <div class="no-signals">
                        <div class="no-signals-icon">üìä</div>
                        <div>No ${signalFilter === 'all' ? '' : signalFilter} signals</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(s => `
                <div class="signal-card ${s.bias}">
                    <div class="signal-header">
                        <div class="signal-name">${s.name}</div>
                        <div class="signal-badge ${s.bias}">${s.bias.toUpperCase()}</div>
                    </div>
                    <div class="signal-details">
                        <div class="signal-detail">
                            <span class="detail-label">Entry:</span>
                            <span class="detail-value">${s.entry}</span>
                        </div>
                        <div class="signal-detail">
                            <span class="detail-label">TP1:</span>
                            <span class="detail-value green">${s.tp1}</span>
                        </div>
                        <div class="signal-detail">
                            <span class="detail-label">TP2:</span>
                            <span class="detail-value green">${s.tp2}</span>
                        </div>
                        <div class="signal-detail">
                            <span class="detail-label">TP3:</span>
                            <span class="detail-value green">${s.tp3}</span>
                        </div>
                        <div class="signal-detail">
                            <span class="detail-label">SL:</span>
                            <span class="detail-value red">${s.sl}</span>
                        </div>
                        <div class="signal-detail">
                            <span class="detail-label">TF:</span>
                            <span class="detail-value">${getTimeframeLabel(s.timeframe)}</span>
                        </div>
                    </div>
                    <div class="confidence-bar">
                        <div class="confidence-fill ${s.confidence >= 85 ? 'high' : ''}" style="width: ${s.confidence}%"></div>
                    </div>
                    <div class="signal-time">${new Date(s.timestamp).toLocaleString()}</div>
                </div>
            `).join('');
        }

        function filterSignals(type) {
            signalFilter = type;
            document.querySelectorAll('.signal-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if ((type === 'all' && btn.textContent === 'All') ||
                    (type === 'bullish' && btn.textContent === 'Bullish') ||
                    (type === 'bearish' && btn.textContent === 'Bearish')) {
                    btn.classList.add('active');
                }
            });
            displaySignals();
        }

        async function clearAllSignals() {
            if (confirm('Clear all signals?')) {
                try {
                    await fetch(`${FIREBASE_URL}/signals.json`, { method: 'DELETE' });
                    allSignals = [];
                    displaySignals();
                } catch (e) {
                    console.error('Firebase clear error:', e);
                }
            }
        }

        function getTimeframeLabel(tf) {
            const labels = { 60: '1M', 300: '5M', 900: '15M', 1800: '30M', 3600: '1H' };
            return labels[tf] || `${tf}s`;
        }

        function toggleSetting(el) {
            el.classList.toggle('active');
        }

        function playSound() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 800;
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.3);
        }

        // Initialize
        window.addEventListener('load', () => {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            loadSignalsFromFirebase();
            
            window.addEventListener('resize', () => {
                Object.values(charts).forEach(c => {
                    c.resizeCanvas();
                    c.draw();
                });
            });
            
            setTimeout(() => startAllCharts(), 500);
        });
    </script>
</body>
</html>
